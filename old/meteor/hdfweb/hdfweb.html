<head>
  <title>HDFWeb</title>
</head>

<body>
      
	{{> header}}
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span3">
          <div class="well sidebar-nav" style="height: 400px;">
            
            {{> folders}}
          </div><!--/.well -->
        </div><!--/span-->
        <div class="span9">
          {{> mainView}}
          <div class="row-fluid">
          </div><!--/row-->
        </div><!--/span-->
      </div><!--/row-->
      <hr>
      {{> webgl}}
      <footer>
        <p>NEMALOAD 2013</p>
      </footer>

    </div><!--/.fluid-container-->
<!-- WebGL script elements for rendering -->
<script id="image-vertex-shader" type="x-shader/x-vertex">
attribute vec2 a_canvCoord;
attribute vec2 a_texCoord;

uniform vec2 u_canvSize;

varying vec2 v_texCoord;

void main() {
  // convert the rectangle from pixels to -1.0 to 1.0
  vec2 clipSpace = a_canvCoord / u_canvSize * 2.0 - 1.0;
  gl_Position = vec4(clipSpace, 0, 1);

  // pass the texCoord to the fragment shader
  // The GPU will interpolate this value between points.
  v_texCoord = a_texCoord;
}
</script>

<script id="image-fragment-shader" type="x-shader/x-fragment">
precision mediump float;

// our texture
uniform sampler2D u_image;

// the texCoords passed in from the vertex shader.
varying vec2 v_texCoord;

uniform vec2 u_gammaGain; // display parameters

void main() {
  vec4 gamma = vec4(u_gammaGain.x, u_gammaGain.x, u_gammaGain.x, u_gammaGain.x);
  vec4 gain = vec4(u_gammaGain.y, u_gammaGain.y, u_gammaGain.y, u_gammaGain.y);
  gl_FragColor = pow(texture2D(u_image, v_texCoord) * gain, gamma);
}
</script>

<script id="lightfield-pinhole-fragment-shader" type="x-shader/x-fragment">
precision mediump float;

// our texture
uniform sampler2D u_image;

// the texCoords passed in from the vertex shader (ST/focal plane)
varying vec2 v_texCoord;
// the observer's coordinates (UV/camera plane)
uniform vec2 u_UVCoord;

// lens grid
uniform vec2 u_gridSize; // number of lens
uniform vec2 u_rectOffset; // center of grid in texCoords
uniform mat2 u_rectLinear; // grid intervals in texCoords

uniform vec2 u_gammaGain; // display parameters

void main(void) {
  vec4 gamma = vec4(u_gammaGain.x, u_gammaGain.x, u_gammaGain.x, u_gammaGain.x);
  vec4 gain = vec4(u_gammaGain.y, u_gammaGain.y, u_gammaGain.y, u_gammaGain.y);

  vec2 coord, coord0, coord1, coord2, coord3, coord4;
  vec4 fracts;
  vec4 color;

  // Coordinates in the lens grid space
  coord = v_texCoord.st * u_gridSize;
  // The interesting in-lens pixel
  coord0 = floor(coord) + u_UVCoord.xy;
  // Examine the four nearest lens, interpolating the final color
  coord1 = u_rectOffset +  coord0                  * u_rectLinear;
  coord2 = u_rectOffset + (coord0 + vec2(0.0,1.0)) * u_rectLinear;
  coord3 = u_rectOffset + (coord0 + vec2(1.0,1.0)) * u_rectLinear;
  coord4 = u_rectOffset + (coord0 + vec2(1.0,0.0)) * u_rectLinear;
  // Interpolation color based on the surrounding lens distance
  fracts = vec4(coord - floor(coord), floor(coord)+vec2(1.0,1.0) - coord);
  color = fracts.z * (fracts.w * texture2D(u_image, coord1) +
          fracts.y * texture2D(u_image, coord2)) +
    fracts.x * (fracts.y * texture2D(u_image, coord3) +
          fracts.w * texture2D(u_image, coord4));

  gl_FragColor = pow(vec4(color.rgb, color.a) * gain, gamma);
}
</script>

<script id="grid-vertex-shader" type="x-shader/x-vertex">
attribute vec2 a_canvCoord;
uniform vec2 u_canvSize;
void main() {
  // convert the rectangle from pixels to -1.0 to 1.0
  vec2 clipSpace = a_canvCoord / u_canvSize * 1.0 - 1.0;
  gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
}
</script>

<script id="grid-fragment-shader" type="x-shader/x-fragment">
precision mediump float;

void main() {
  gl_FragColor = vec4(0.0, 1.0, 0.0, 0.2);
}
</script>


</body>

<template name="mainView">
	<div class="hero-unit"  style="height:300px;" overflow="auto">
    <!--Stuff that everyone sees -->
    {{#if isViewing "viewingAbout"}}

      <p> This is the about screen </p>

    {{/if}}

    {{#if isViewing "viewingHelp"}}

      <p> This is the Help screen </p>

    {{/if}}
    <!-- Stuff that logged in users can see -->
    {{#if currentUser}}

      {{#if isViewing "viewingFirstScreen"}}
      
        <p> Please choose a dataset to explore from the list to the left. </p>
      
      {{/if}}
      
      {{#if isViewing "fileListing"}}
      
      {{> fileView}}
      
      {{/if}}
    <!--Stuff that people who aren't logged in see -->
    {{else}}
      
      {{#if isViewing "viewingFirstScreen"}}
      
        <h1> Welcome to HDFWeb </h1>
        HDFWeb allows both NEMALOAD researchers and the public to interactively view
        the project data.
        <p><a href="http://nemaload.github.io/HDFWeb" class="btn btn-primary btn-large">Learn more &raquo;</a></p>
      
      {{/if}}
      
      {{#if isViewing "fileListing"}}
        
        <p> You need to log in to view files. </p>
      
      {{/if}}
    
    {{/if}}

            
  </div>
</template>


<template name="fileView">
  <h3> {{getFolderName}} </h3>
<div style="height: 300px; overflow: auto;">
<table class="table table-striped" >
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Size</th>
    </tr>
  </thead>
  <tbody>
{{#each filesWithId}}
<tr class="fileViewRow" fileId={{_id}}>
<td> {{_id}} </td>
<td> {{baseName}} </td>
<td> {{size}} </td>
</tr>
{{/each}}
</tbody>
</table>
</div>
</template>





<template name="header">
  <div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container-fluid">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="brand" id="triggerFirstScreen">HDFWeb</a>
              <div class="nav-collapse collapse">
                <div class="navbar-text pull-right">
                  {{loginButtons align="right"}}
                </div>
              <ul class="nav">
                <li><a id="triggerAbout">About</a></li>       
                <li><a id="triggerHelp">Help</a></li>
                <li><a href="http://nemaload.com" target="_blank">NEMALOAD</a></li>
                <li><p id="databaseConnection"><i class="icon-cloud"></i> Status: {{connectionStatus}}</p></li>
              </ul>
            </div><!--/.nav-collapse -->
        </div>
    </div>
  </div>
</template>

<!-- Folder related templates -->

<!-- The folder nav list -->
<template name="folders">
  <ul class="nav nav-list" >
  <li class="nav-header"><i class="icon-folder-close"></i> Folders</li>
  {{#each folders}}
    {{#if isCurrentFolder _id}}
    <li><a id="{{_id}}"><i class="icon-folder-open-alt"></i> {{name}}</a></li>
    {{else}}
    <li><a id="{{_id}}"><i class="icon-folder-close-alt"></i> {{name}}</a></li>
    {{/if}}
  {{/each}}
</ul>
</template>

<!-- The new folder input -->
<template name="newFolderInput">
  <input id="new_folder_name" type="text" />
  <input type="button" value="Add Folder" />
</template>


<!-- WebGL stuff -->
<template name="webgl">

<div class="controls">

<p class="controlbox">
Please select an image to view.<br />
<!-- These are generated with a Python script for now due to cross-domain limitations I violated while half-awake -->
<select id="imageselect">
  <option value="/images/lensgrid.hdf5.png">lensgrid</option>
  <option value="/images/beads_w_lenses.hdf5.png">beads_w_lenses</option>
  <option value="/images/beads_w_lenses2.hdf5.png">beads_w_lenses2</option>
  <option value="/images/beads_w_lenses3.hdf5.png">beads_w_lenses3</option>
  <option value="/images/beads_wo_lenses.hdf5.png">beads_wo_lenses</option>
  <option value="/images/beads_wo_lenses2.hdf5.png">beads_wo_lenses2</option>
  <option value="/images/beads_wo_lenses3.hdf5.png">beads_wo_lenses3</option>
  <option value="/images/beads_w_lenses.hdf5.png">beads_w_lenses</option>
  <option value="/images/beads_w_lenses2.hdf5.png">beads_w_lenses2</option>
  <option value="/images/2D_beads_w_lenses.hdf5.png">2D_beads_w_lenses</option>
  <option value="/images/MT21063_1.hdf5.png">MT21063_1</option>
  <option value="/images/MT21063_video1.hdf5.png">MT21063_video1</option>
  <option value="/images/MT21063_video10.hdf5.png">MT21063_video10</option>
  <option value="/images/MT21063_video11.hdf5.png">MT21063_video11</option>
  <option value="/images/Epi_63xZeiss_1.4_3beads_w_lenses1.hdf5.png">Epi_63xZeiss_1.4_3beads_w_lenses1</option>
  <option value="/images/Epi_63xZeiss_1.4_3beads_w_lenses2.hdf5.png">Epi_63xZeiss_1.4_3beads_w_lenses2</option>
  <option value="/images/Epi_63xZeiss_1.4_3beads_wo_lenses.hdf5.png">Epi_63xZeiss_1.4_3beads_wo_lenses</option>
  <option value="/images/Epi_63xZeiss_1.4_pollen_w_lenses.hdf5.png">Epi_63xZeiss_1.4_pollen_w_lenses</option>
  <option value="/images/Epi_63xZeiss_1.4_pollen_wo_lenses.hdf5.png">Epi_63xZeiss_1.4_pollen_wo_lenses</option>
  <option value="/images/Kohler_63xZeiss_1.4_pollen_w_lenses.hdf5.png">Kohler_63xZeiss_1.4_pollen_w_lenses</option>
  <option value="/images/Kohler_63xZeiss_1.4_pollen_wo_lenses.hdf5.png">Kohler_63xZeiss_1.4_pollen_wo_lenses</option>
  <option value="/images/Drosophila_brain_w_lenses.hdf5.png">Drosophila_brain_w_lenses</option>
  <option value="/images/Drosophila_brain_w_lenses2.hdf5.png">Drosophila_brain_w_lenses2</option>
  <option value="/images/Drosophila_brain_w_lenses.hdf5.png">Drosophila_brain_w_lenses</option>
  <option value="/images/Drosophila_brain_w_lenses2.hdf5.png">Drosophila_brain_w_lenses2</option>
  <option value="/images/Drosophila_brain_wo_lenses.hdf5.png">Drosophila_brain_wo_lenses</option>
  <option value="/images/Drosophila_brain_wo_lenses2.hdf5.png">Drosophila_brain_wo_lenses2</option>
  <option value="/images/Olympus_60x_1.45_beads_w_lenses.hdf5.png">Olympus_60x_1.45_beads_w_lenses</option>
  <option value="/images/Olympus_60x_1.45_beads_wo_lenses.hdf5.png">Olympus_60x_1.45_beads_wo_lenses</option>
  <option value="/images/beads_wo_lenses.hdf5.png">beads_wo_lenses</option>
  <option value="/images/beads_wo_lenses2.hdf5.png">beads_wo_lenses2</option>
  <option value="/images/larger_beads_w_lenses.hdf5.png">larger_beads_w_lenses</option>
  <option value="/images/larger_beads_w_lenses2.hdf5.png">larger_beads_w_lenses2</option>
  <option value="/images/larger_beads_w_lenses2_180rot.hdf5.png">larger_beads_w_lenses2_180rot</option>
  <option value="/images/larger_beads_wo_lenses.hdf5.png">larger_beads_wo_lenses</option>
  <option value="/images/larger_beads_wo_lenses2.hdf5.png">larger_beads_wo_lenses2</option>
  <option value="/images/2D_beads_w_lenses_diff_z1.hdf5.png">2D_beads_w_lenses_diff_z1</option>
  <option value="/images/2D_beads_w_lenses_diff_z2.hdf5.png">2D_beads_w_lenses_diff_z2</option>
  <option value="/images/2D_beads_w_lenses_diff_z3.hdf5.png">2D_beads_w_lenses_diff_z3</option>
  <option value="/images/2D_beads_wo_lenses.hdf5.png">2D_beads_wo_lenses</option>
  <option value="/images/beads_3D_w_lenses.hdf5.png">beads_3D_w_lenses</option>
  <option value="/images/beads_3D_w_lenses_diff_z1.hdf5.png">beads_3D_w_lenses_diff_z1</option>
  <option value="/images/beads_3D_w_lenses_diff_z2.hdf5.png">beads_3D_w_lenses_diff_z2</option>
  <option value="/images/beads_3D_w_lenses_diff_z3.hdf5.png">beads_3D_w_lenses_diff_z3</option>
  <option value="/images/beads_3D_w_lenses_diff_z4.hdf5.png">beads_3D_w_lenses_diff_z4</option>
  <option value="/images/beads_3D_w_lenses_diff_z5.hdf5.png">beads_3D_w_lenses_diff_z5</option>
  <option value="/images/beads_3D_w_lenses_diff_z6.hdf5.png">beads_3D_w_lenses_diff_z6</option>
  <option value="/images/beads_3D_wo_lenses.hdf5.png">beads_3D_wo_lenses</option>
  <option value="/images/dense_2D_beads_w_lenses.hdf5.png">dense_2D_beads_w_lenses</option>
  <option value="/images/dense_2D_beads_w_lenses_diff_z1.hdf5.png">dense_2D_beads_w_lenses_diff_z1</option>
  <option value="/images/dense_2D_beads_w_lenses_diff_z2.hdf5.png">dense_2D_beads_w_lenses_diff_z2</option>
  <option value="/images/dense_2D_beads_w_lenses_diff_z3.hdf5.png">dense_2D_beads_w_lenses_diff_z3</option>
  <option value="/images/dense_2D_beads_wo_lenses.hdf5.png">dense_2D_beads_wo_lenses</option>
  <option value="/images/MT21063_video12.hdf5.png">MT21063_video12</option>
  <option value="/images/MT21063_video13.hdf5.png">MT21063_video13</option>
  <option value="/images/MT21063_video14.hdf5.png">MT21063_video14</option>
  <option value="/images/MT21063_video2.hdf5.png">MT21063_video2</option>
  <option value="/images/MT21063_video3.hdf5.png">MT21063_video3</option>
  <option value="/images/MT21063_video4.hdf5.png">MT21063_video4</option>
  <option value="/images/MT21063_video15.hdf5.png">MT21063_video15</option>
  <option value="/images/MT21063_video16_rolling.hdf5.png">MT21063_video16_rolling</option>
  <option value="/images/MT21063_video17_rolling.hdf5.png">MT21063_video17_rolling</option>
  <option value="/images/MT21063_video18_rolling_dz_ml.hdf5.png">MT21063_video18_rolling_dz_ml</option>
  <option value="/images/cell_layer_pawel_blue.hdf5.png">cell_layer_pawel_blue</option>
  <option value="/images/cell_layer_pawel_blue_2.hdf5.png">cell_layer_pawel_blue_2</option>
  <option value="/images/cell_layer_pawel_green.hdf5.png">cell_layer_pawel_green</option>
  <option value="/images/cell_layer_pawel_green_2.hdf5.png">cell_layer_pawel_green_2</option>
  <option value="/images/cell_layer_pawel_red.hdf5.png">cell_layer_pawel_red</option>
  <option value="/images/cells2_pawel_blue.hdf5.png">cells2_pawel_blue</option>
  <option value="/images/cells2_pawel_blue_2.5x.hdf5.png">cells2_pawel_blue_2.5x</option>
  <option value="/images/cells2_pawel_green.hdf5.png">cells2_pawel_green</option>
  <option value="/images/cells2_pawel_green_2.5x.hdf5.png">cells2_pawel_green_2.5x</option>
  <option value="/images/cells2_pawel_red.hdf5.png">cells2_pawel_red</option>
  <option value="/images/cells2_pawel_red_2.5x.hdf5.png">cells2_pawel_red_2.5x</option>
  <option value="/images/pflp18gCAMP5_mCherry_video20_global_dz_ml.hdf5.png">pflp18gCAMP5_mCherry_video20_global_dz_ml</option>
  <option value="/images/pflp18gCAMP5_mCherry_video21_global.hdf5.png">pflp18gCAMP5_mCherry_video21_global</option>
  <option value="/images/punc31_gCAMP5_td_snapshot_1.6x_gfpfilter.hdf5.png">punc31_gCAMP5_td_snapshot_1.6x_gfpfilter</option>
  <option value="/images/punc31_gCAMP5_td_snapshot_1.6x_gfpfilter_2.hdf5.png">punc31_gCAMP5_td_snapshot_1.6x_gfpfilter_2</option>
  <option value="/images/punc31_gCAMP5_td_snapshot_1.6x_gfpfilter_4.hdf5.png">punc31_gCAMP5_td_snapshot_1.6x_gfpfilter_4</option>
  <option value="/images/punc31_gCAMP5_td_video22_global.hdf5.png">punc31_gCAMP5_td_video22_global</option>
  <option value="/images/punc31_gCAMP5_td_video23_global_gfpfilter.hdf5.png">punc31_gCAMP5_td_video23_global_gfpfilter</option>
  <option value="/images/punc31_gCAMP5_td_video24_global_gfpfilter_tail.hdf5.png">punc31_gCAMP5_td_video24_global_gfpfilter_tail</option>
  <option value="/images/punc31_gCAMP5_td_video25_global_gfpfilter.hdf5.png">punc31_gCAMP5_td_video25_global_gfpfilter</option>
</select>
</p>

<div class="controlbox">
<select id="rendermode">
  <option value="image">Image</option>
  <option value="lightfield">Light field</option>
</select>
</div>

<table class="controlbox">
  <tr><td>Gain:</td><td><input type="range" id="gain" value="0" min="-1" max="1" step="0.05" /></td><td><span id="gain_current" style="width: 5em"></span></td></tr>
  <tr><td>Gamma:</td><td><input type="range" id="gamma" value="1" min="0.5" max="1.5" step="0.01" /></td><td><span id="gamma_current" style="width: 5em"></span></td></tr>
</table>

<p class="controlbox">
<input type="checkbox" id="grid" value="1" /> Grid
</p>

<p id="controls-lightfield" class="controlbox">
<input type="button" value="U-" onClick="updateUV(-1.0, 0);">
<input type="button" value="U+" onClick="updateUV(+1.0, 0);">
<span id="U_current" style="width: 5em"></span>
<br />
<input type="button" value="V-" onClick="updateUV(0, -1.0);">
<input type="button" value="V+" onClick="updateUV(0, +1.0);">
<span id="V_current" style="width: 5em"></span>
</p>

</div>

<canvas id="canvas-image" width="1080" height="1280"></canvas>
<canvas id="canvas-lightfield" width="432" height="512"></canvas>
</template>


		
			  
      
